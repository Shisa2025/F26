<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Kaiju Response Synopsis</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-black text-slate-100">
  <audio id="bgm" src="synopsis/bgm/yashimasakusen.MP3" preload="auto" loop autoplay playsinline></audio>

  <div id="stage" class="relative min-h-screen w-full overflow-hidden cursor-pointer select-none">
    <img id="slide-image" src="synopsis/picture/img1.png" alt="" class="absolute inset-0 h-full w-full object-cover brightness-90" />
    <div class="absolute inset-0 bg-gradient-to-b from-black/70 via-black/50 to-black/80"></div>

    <div class="absolute inset-0 flex items-center justify-center px-6 text-center">
      <div class="space-y-4 max-w-4xl">
        <div id="slide-line" class="text-3xl sm:text-4xl md:text-5xl font-extrabold tracking-tight drop-shadow-xl"></div>
        <div id="slide-hint" class="text-sm text-slate-200/70">Click or wait Â· 12 seconds per slide</div>
      </div>
    </div>

    <div id="start-screen" class="absolute inset-0 flex flex-col items-center justify-center gap-4 px-4 bg-black/70 backdrop-blur-sm hidden">
      <div class="text-3xl sm:text-4xl font-extrabold">Start briefing with sound</div>
      <div class="text-sm text-slate-200/80">Click to enable audio and begin the slideshow</div>
      <button id="start-btn" class="px-5 py-3 rounded-full bg-emerald-500 text-slate-950 font-semibold shadow-lg hover:-translate-y-0.5 transition">Start</button>
    </div>

    <div id="cta" class="absolute inset-0 flex flex-col items-center justify-center gap-4 px-4 hidden bg-black/70 backdrop-blur-sm">
      <div class="text-3xl sm:text-4xl font-extrabold">Briefing complete</div>
      <div class="flex flex-wrap gap-3">
        <button id="replay" class="px-5 py-3 rounded-full bg-emerald-500 text-slate-950 font-semibold shadow-lg hover:-translate-y-0.5 transition">See again</button>
        <a href="index.html" class="px-5 py-3 rounded-full border border-white/20 bg-white/10 hover:bg-white/20 transition">Go back</a>
      </div>
    </div>

    <div id="audio-status" class="absolute top-4 right-4 text-xs px-3 py-1 rounded-full bg-white/10 border border-white/20 backdrop-blur">
      BGM: Autoplay enabled (click page if muted)
    </div>
  </div>

  <script>
    const defaultSlides = [
      { src: "synopsis/picture/img1.png", line: "Unidentified lifeforms have simultaneously appeared across the globe." },
      { src: "synopsis/picture/img2.png", line: "From aerial predators to terrestrial behemoths, they are tearing our world apart." },
      { src: "synopsis/picture/img3.png", line: "Communications are down. Without centralized data, humanity is losing the war." },
      { src: "synopsis/picture/img4.png", line: "Our only hope lies in a digital nexus capable of real-time tracking and global command." },
      { src: "synopsis/picture/img5.png", line: "The Government has formed the \"Super Beast Countermeasure Agency\" and activated the 'Lolo' defense grid." },
      { src: "synopsis/picture/img6.png", line: "Control has been transferred to you. Log in, repel the monsters, and save our civilization." }
    ];
    let slides = [...defaultSlides];

    const audio = document.getElementById("bgm");
    const imageEl = document.getElementById("slide-image");
    const lineEl = document.getElementById("slide-line");
    const hintEl = document.getElementById("slide-hint");
    const stage = document.getElementById("stage");
    const cta = document.getElementById("cta");
    const replayBtn = document.getElementById("replay");
    const audioStatus = document.getElementById("audio-status");
    const startScreen = document.getElementById("start-screen");
    const startBtn = document.getElementById("start-btn");

    let idx = 0;
    let timer = null;
    let typingInterval = null;
    let ended = false;
    let started = false;
    let userInteracted = false;
    const DURATION = 12000;
    audio.volume = 0.7;

    function setSlide(nextIdx) {
      idx = nextIdx;
      const s = slides[idx] || slides[0];
      clearInterval(typingInterval);
      clearTimeout(timer);
      imageEl.src = s.src;
      lineEl.textContent = "";
      lineEl.classList.remove("hidden");
      hintEl.classList.remove("hidden");
      lineEl.style.animation = "none";
      void lineEl.offsetHeight; // reset animation
      lineEl.style.animation = "fadeInZoom 0.8s ease";
      cta.classList.add("hidden");
      ended = false;
      typeLine(s.line);
    }

    function scheduleNext() {
      clearTimeout(timer);
      timer = setTimeout(handleAdvance, DURATION);
    }

    function handleAdvance() {
      if (ended) return;
      if (!started) return;
      clearTimeout(timer);
      if (typingInterval) {
        clearInterval(typingInterval);
        typingInterval = null;
        const s = slides[idx] || slides[0];
        lineEl.textContent = s.line;
        scheduleNext();
        return;
      }
      if (idx < slides.length - 1) {
        setSlide(idx + 1);
      } else {
        finishShow();
      }
    }

    function finishShow() {
      clearTimeout(timer);
      hintEl.classList.add("hidden");
      lineEl.classList.add("hidden");
      cta.classList.remove("hidden");
      ended = true;
    }

    function typeLine(text) {
      if (!text) {
        scheduleNext();
        return;
      }
      let i = 0;
      typingInterval = setInterval(() => {
        lineEl.textContent += text[i] || "";
        i += 1;
        if (i >= text.length) {
          clearInterval(typingInterval);
          typingInterval = null;
          scheduleNext();
        }
      }, 80);
    }

    function updateAudioStatus(state) {
      if (state === "playing") {
        audioStatus.textContent = "BGM: Playing (loop)";
      } else if (state === "needs-click") {
        audioStatus.textContent = "BGM: Click anywhere to start audio";
      } else if (state === "unmuted") {
        audioStatus.textContent = "BGM: Unmuted, trying to play...";
      }
    }

    function beginShow() {
      if (started) return;
      started = true;
      startScreen.classList.add("hidden");
      setSlide(0, true);
    }

    async function ensureAudio(gesture = false) {
      if (gesture) {
        userInteracted = true;
        audio.muted = false;
        updateAudioStatus("unmuted");
      }
      try {
        await audio.play();
        updateAudioStatus("playing");
      } catch (err) {
        updateAudioStatus("needs-click");
      }
    }

    async function attemptAutoplay() {
      try {
        await audio.play();
        updateAudioStatus("playing");
        beginShow();
      } catch (err) {
        startScreen.classList.remove("hidden");
        updateAudioStatus("needs-click");
      }
    }

    async function loadSlidesFromText() {
      try {
        const res = await fetch("synopsis/description.txt");
        if (!res.ok) throw new Error("desc fetch failed");
        const text = await res.text();
        const lines = text.split(/\r?\n/).map((l) => l.trim()).filter(Boolean);
        if (lines.length === 0) throw new Error("no lines");
        const count = Math.min(lines.length, 6);
        slides = Array.from({ length: count }, (_, i) => ({
          src: `synopsis/picture/img${i + 1}.png`,
          line: lines[i]
        }));
      } catch (err) {
        slides = [...defaultSlides];
      } finally {
        setSlide(0, started);
      }
    }

    stage.addEventListener("click", () => {
      if (!started) {
        ensureAudio(true).then(beginShow);
      } else {
        ensureAudio(true);
        handleAdvance();
      }
    });
    replayBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      setSlide(0);
      ensureAudio(true);
    });

    startBtn.addEventListener("click", () => {
      ensureAudio(true).then(beginShow);
    });

    window.addEventListener("load", () => {
      setSlide(0, false);
      attemptAutoplay();
      loadSlidesFromText();
    });

    audio.addEventListener("play", () => updateAudioStatus("playing"));
    audio.addEventListener("pause", () => {
      if (!userInteracted) updateAudioStatus("needs-click");
    });

    // Keyframes for text entrance
    const style = document.createElement("style");
    style.innerHTML = `
      @keyframes fadeInZoom {
        from { opacity: 0; transform: scale(0.94); }
        to { opacity: 1; transform: scale(1); }
      }
    `;
    document.head.appendChild(style);
  </script>
</body>
</html>
